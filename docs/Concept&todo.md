# 本のコモンズ — プロジェクト構想 v2.0

---

## 0. 前提思想

本のコモンズは Comm0ns 構想の最小実装である。Comm0ns のネットワーク哲学——「身内の身内」への内側深化——を、書籍の共有という低リスクな形で実証する。

したがって、このアプリは**オープンなプラットフォームではない**。信頼の連鎖によって成り立つクローズドなコミュニティ基盤であり、「自分が誰であり、誰とどういう関係にあるか」がすべての機能の前提となる。

---

## 1. コアコンセプト

### 1-1. 関係性ベースのアイデンティティ

ユーザーは単独では存在しない。必ず「誰かとの関係性」によって自分の立ち位置が定義される。

- 登録自体は可能だが、**関係性の記載なしには機能が制限される**（閲覧のみ等）
- プロフィールには「誰の紹介か」「誰とどんな関係か」が明示される
- これにより、初めて会う相手でも「○○さんの大学時代の友人」とわかり、信頼の文脈が生まれる

### 1-2. 場所に紐づく所有

本は「人」だけでなく「場所」にも属する。

- シェアハウスの共有本棚、オフィスのライブラリ、実家の書斎など
- 複数人が共同所有する本は「場所」を大元とし、その場所に関わる人々が管理者となる
- 本の物理的な所在地が常に明確である

---

## 2. ユーザーモデル

### 2-1. ユーザーの状態遷移

```
[未登録] → [登録済・未認証] → [認証済（アクティブ）]
```

| 状態 | できること | できないこと |
|---|---|---|
| 未登録 | なし | すべて |
| 登録済・未認証 | プロフィール閲覧、招待リンクの確認 | 本の登録、貸出リクエスト、感想投稿 |
| 認証済 | すべての機能 | — |

**認証条件：**
- 最低1人の既存メンバーとの関係性が記載されている
- その関係性が相手側から承認されている（双方向確認）

### 2-2. プロフィール構成

```
ユーザープロフィール
├── 基本情報
│   ├── 名前（表示名）
│   ├── アイコン / 写真
│   ├── ひとこと自己紹介
│   └── 居住エリア（任意の粒度）
│
├── 関係性マップ（必須・コア）
│   ├── 関係性1: [相手ユーザー] — [関係の種類] — [補足]
│   ├── 関係性2: ...
│   └── （最低1つ必須、追加は任意）
│
├── 所属する場所
│   ├── 場所1: [シェアハウス名] — [役割: 住人/管理者]
│   ├── 場所2: [オフィス名] — [役割: メンバー]
│   └── ...
│
└── 本棚サマリー
    ├── 所有冊数
    ├── 貸出可能冊数
    └── 感想数
```

### 2-3. 関係性の種類（初期テンプレート）

ユーザーが自由記述も可能だが、選択肢として以下を用意：

- 家族（親/子/兄弟姉妹/配偶者/親戚）
- 友人（幼馴染/学生時代/社会人から）
- 同居人（シェアハウス/ルームメイト）
- 同僚（会社/プロジェクト）
- 師弟（先生/生徒/メンター）
- コミュニティ仲間（サークル/趣味/活動）
- その他（自由記述）

---

## 3. 場所モデル

### 3-1. 場所とは

「場所」は本が物理的に存在する空間を表す。個人の自宅も場所だが、特に重要なのは**複数人が共有する場所**。

### 3-2. 場所の構成

```
場所
├── 基本情報
│   ├── 名前（例：「下北沢シェアハウス」「渋谷オフィス」）
│   ├── 種類（自宅 / シェアハウス / オフィス / コミュニティスペース / その他）
│   ├── 住所またはエリア（任意の粒度）
│   └── 説明
│
├── メンバー
│   ├── 管理者（場所の本を追加・削除できる）
│   └── 関係者（その場所にアクセスできる人）
│
└── 本棚
    ├── 所有形態: 共有 / [個人名]の私物（ただしここに置いてある）
    └── 本のリスト
```

### 3-3. 場所のタイプ別挙動

| タイプ | 所有者 | 貸出権限 | 本の追加 |
|---|---|---|---|
| 個人の自宅 | 本人 | 本人のみ | 本人のみ |
| シェアハウス | 共有（管理者複数） | 管理者の誰でも | 管理者の誰でも |
| オフィス | 組織 | 管理者 | 管理者 |
| コミュニティスペース | 共有 | 管理者 | 管理者 |

---

## 4. 本の所有モデル

### 4-1. 所有パターン

```
パターンA: 個人所有・個人宅
  → 田中さんが自宅に持っている『三体』

パターンB: 個人所有・共有場所に設置
  → 田中さんの『三体』がシェアハウスの本棚にある
  → 所有者: 田中、所在地: 下北沢シェアハウス

パターンC: 共有所有・共有場所
  → シェアハウスの共有本として購入した『サピエンス全史』
  → 所有者: 下北沢シェアハウス（共有）、所在地: 下北沢シェアハウス

パターンD: 貸出中（場所が移動）
  → 田中さんの『三体』を佐藤さんが借りている
  → 所有者: 田中、現在地: 佐藤さん宅
```

### 4-2. 本のデータ構造

```
本
├── 書籍情報（ISBN由来）
│   ├── タイトル、著者、出版社、ページ数、カバー画像
│   └── ジャンルタグ
│
├── 所有情報
│   ├── 所有者: [ユーザー] or [場所（共有）]
│   ├── 大元の場所（ホームロケーション）
│   └── 現在の所在地（ホームと異なる場合）
│
├── ステータス
│   ├── available: 貸出可能
│   ├── lent_out: 貸出中（→ 借用者・現在地を表示）
│   ├── reading: 読書中
│   └── private: 非公開
│
└── 関連データ
    ├── 感想・レビュー
    └── 貸出履歴
```

---

## 5. 貸出フロー

### 5-1. 個人所有の本

```
借りたい人がリクエスト
  → 所有者に通知
  → 所有者が承認 or 拒否
  → 承認後：受け渡し方法を相談（チャット or メッセージ）
  → 受け渡し完了 → ステータス更新（所在地が移動）
  → 返却 → 所有者が確認 → ステータス復帰
```

### 5-2. 共有場所の本

```
借りたい人がリクエスト
  → 場所の管理者（誰でも1人）が承認
  → 借用者がその場所に取りに行く
  → 持ち出し記録 → ステータス更新
  → 返却時：場所に戻す → 管理者 or 本人が確認
```

### 5-3. 信頼距離の表示

貸出リクエスト時、相手との「信頼距離」を表示する：

- **直接の知り合い（距離1）：** 田中 → 佐藤
- **友人の友人（距離2）：** 田中 → 佐藤 → 鈴木
- **距離3以上：** 表示はするが、貸出は所有者の判断に委ねる

---

## 6. 招待と成長モデル

### 6-1. 招待フロー

```
既存メンバーが招待リンクを生成
  → 新規ユーザーが登録
  → 招待者との関係性が自動的に仮作成される
  → 招待者が関係性を承認
  → 新規ユーザーが関係の詳細（種類・補足）を記入
  → 認証完了 → フル機能解放
```

### 6-2. 成長の制約

- 招待は既存メンバーからのみ
- 1人のメンバーが招待できる人数に上限を設けるか → 初期は制限なし、後に検討
- 関係性の承認は双方向必須

---

## 7. 画面構成（改訂版）

### モバイル版

| 画面 | 主な変更点 |
|---|---|
| ホーム | 関係性ネットワークの簡易表示を追加 |
| 検索 | 場所フィルター追加（「下北沢シェアハウスの本」等） |
| マイ本棚 | 場所別グルーピング表示 |
| 貸出管理 | 信頼距離の表示、場所ベースの貸出対応 |
| プロフィール | 関係性マップ、所属場所の表示 |

### Web版

| 画面 | 主な変更点 |
|---|---|
| ホーム | サイドバーに関係性ネットワーク図 |
| 検索 | 左カラムに場所・関係性フィルター |
| 本の詳細 | 所在地マップ、所有形態の明示 |
| 場所ページ（新規） | 場所の本棚一覧、メンバー、地図 |
| ユーザープロフィール | 関係性チェーン表示（自分との距離） |

---

## 8. データモデル（概要）

```
Users
  id, name, icon, bio, area, status(unverified/active), created_at

Relationships
  id, user_a_id, user_b_id, type, note, 
  confirmed_by_a, confirmed_by_b, created_at

Places
  id, name, type, area, address, description, created_at

PlaceMembers
  id, place_id, user_id, role(admin/member), joined_at

Books
  id, isbn, title, author, publisher, pages, cover_url, genre_tags

BookInstances（本の「一冊」を表す）
  id, book_id, 
  owner_type(user/place), owner_id,
  home_place_id,
  current_holder_type(user/place), current_holder_id,
  status(available/lent_out/reading/private),
  added_by, added_at

Loans
  id, book_instance_id, 
  lender_type(user/place), lender_id,
  borrower_id,
  status(requested/approved/active/returned/rejected),
  message, requested_at, approved_at, returned_at

Reviews
  id, book_id, user_id, rating, body, created_at

Invitations
  id, inviter_id, token, used_by, created_at, used_at
```

**重要な設計判断：BookとBookInstanceの分離**

- `Books` = 書籍マスタ（ISBN単位、全ユーザー共通）
- `BookInstances` = 物理的な「一冊」（同じ本を3人が持っていれば3レコード）
- これにより「同じ『三体』でも、田中さんの一冊とシェアハウスの一冊は別物」を表現

---

## 9. 技術スタック（想定）

| レイヤー | 候補 |
|---|---|
| フロントエンド（モバイル） | React Native / Expo |
| フロントエンド（Web） | Next.js（React） |
| バックエンド | Supabase（PostgreSQL + Auth + Realtime） |
| ISBN検索 | OpenBD API / Google Books API |
| 画像ストレージ | Supabase Storage |
| 通知 | Expo Push Notifications / Web Push |
| デプロイ | Vercel（Web）/ EAS（モバイル） |

---

## 10. タスク分解（AI実行用）

以下のタスクはそれぞれ独立して AI に投げられる粒度で記述。依存関係がある場合は明記。

---

### Phase 0: 基盤セットアップ

#### T-001: Supabase プロジェクト初期設定
```
目的: データベースと認証の基盤を構築する
入力: なし
成果物: Supabase プロジェクト設定ファイル、環境変数テンプレート
作業内容:
  - Supabase プロジェクト作成手順のドキュメント化
  - 環境変数テンプレート（.env.example）の作成
  - Supabase クライアント初期化コード（TypeScript）
依存: なし
```

#### T-002: データベーススキーマ作成
```
目的: 全テーブルのマイグレーションファイルを作成
入力: 本ドキュメントのセクション8「データモデル」
成果物: SQL マイグレーションファイル群
作業内容:
  - Users テーブル（Supabase Auth と連携）
  - Relationships テーブル（双方向確認フラグ付き）
  - Places, PlaceMembers テーブル
  - Books, BookInstances テーブル
  - Loans テーブル
  - Reviews テーブル
  - Invitations テーブル
  - RLS（Row Level Security）ポリシー設定
  - インデックス設計
依存: T-001
```

#### T-003: TypeScript 型定義
```
目的: フロントエンドで使う型を定義
入力: T-002 のスキーマ
成果物: types.ts ファイル
作業内容:
  - 全テーブルの TypeScript 型
  - API レスポンスの型
  - フォーム入力の型
  - enum 定義（ステータス、関係性タイプ等）
依存: T-002
```

---

### Phase 1: 認証・ユーザー・関係性

#### T-010: ユーザー登録・ログインフロー
```
目的: メール or ソーシャルログインによる認証
入力: Supabase Auth のドキュメント
成果物: 登録・ログイン画面コンポーネント、認証フック
作業内容:
  - サインアップ画面（メール + パスワード）
  - ログイン画面
  - パスワードリセット
  - useAuth カスタムフック
  - 認証状態に基づくルーティング
依存: T-001
```

#### T-011: プロフィール作成・編集画面
```
目的: ユーザーが基本情報を入力・編集できる
入力: セクション2-2「プロフィール構成」
成果物: プロフィール編集画面、プロフィール表示コンポーネント
作業内容:
  - 名前、アイコン、自己紹介、居住エリアの入力フォーム
  - アイコン画像アップロード（Supabase Storage）
  - プロフィール表示コンポーネント（他者から見た表示）
  - 未認証状態の警告表示（「関係性を追加してください」）
依存: T-010
```

#### T-012: 関係性の追加・承認フロー
```
目的: ユーザー間の関係性を双方向で確認・管理する
入力: セクション2-3「関係性の種類」
成果物: 関係性追加画面、承認通知、関係性一覧コンポーネント
作業内容:
  - ユーザー検索（名前・メールで既存メンバーを検索）
  - 関係性追加フォーム（相手選択 → 種類選択 → 補足記入）
  - 相手側への承認リクエスト通知
  - 承認・拒否の操作UI
  - 双方承認後のステータス更新
  - 関係性一覧表示（プロフィール内）
  - 認証ステータスの自動更新（関係性1件以上で認証済みに）
依存: T-010, T-011
```

#### T-013: 招待リンク生成・利用フロー
```
目的: 既存メンバーが新メンバーを招待できる
入力: セクション6「招待と成長モデル」
成果物: 招待リンク生成UI、招待経由の登録フロー
作業内容:
  - 招待リンク生成画面（トークン付きURL）
  - 招待リンク経由での登録画面（通常登録 + 招待者情報の表示）
  - 招待者との関係性の自動仮作成
  - 招待トークンの有効期限管理
依存: T-010, T-012
```

#### T-014: 信頼距離の計算ロジック
```
目的: 任意の2ユーザー間の関係性の距離を算出する
入力: Relationships テーブル
成果物: ユーティリティ関数（calculateTrustDistance）
作業内容:
  - BFS（幅優先探索）による最短距離計算
  - Supabase Edge Function or クライアントサイドでの実装
  - キャッシュ戦略の検討
  - 距離に応じた表示文言（「直接の知り合い」「友人の友人」等）
依存: T-002
```

---

### Phase 2: 場所管理

#### T-020: 場所の作成・編集画面
```
目的: シェアハウスやオフィスなどの「場所」を登録・管理できる
入力: セクション3「場所モデル」
成果物: 場所作成フォーム、場所編集画面、場所一覧
作業内容:
  - 場所作成フォーム（名前、種類、エリア、説明）
  - 場所の編集・削除
  - 場所一覧画面（自分が所属する場所）
  - 場所詳細画面（メンバー一覧、本棚）
依存: T-002
```

#### T-021: 場所メンバー管理
```
目的: 場所に管理者・メンバーを追加・管理できる
入力: セクション3-2「場所の構成」
成果物: メンバー追加UI、役割管理、メンバー一覧
作業内容:
  - 既存ユーザーを場所に招待する機能
  - 管理者 / メンバーの役割設定
  - 役割に基づく権限制御（管理者のみ本の追加・削除可能等）
  - メンバーの追加・削除UI
依存: T-020, T-010
```

---

### Phase 3: 本の管理

#### T-030: ISBN検索・本の登録フロー
```
目的: ISBNから書籍情報を取得し、本を登録できる
入力: OpenBD API / Google Books API のドキュメント
成果物: ISBN検索コンポーネント、本の登録フォーム
作業内容:
  - ISBNバーコードスキャン（カメラ利用、モバイル）
  - ISBN手動入力
  - OpenBD API / Google Books API への問い合わせ
  - 検索結果の表示・確認
  - Books マスタへの登録（既存チェック）
  - BookInstance の作成（所有者・場所の指定）
依存: T-002, T-003
```

#### T-031: 本の所有形態設定
```
目的: 個人所有か共有所有か、どの場所に置くかを設定できる
入力: セクション4「本の所有モデル」
成果物: 所有形態選択UI、場所紐付けUI
作業内容:
  - 所有者タイプの選択（自分 / 場所の共有物）
  - ホームロケーション（大元の場所）の設定
  - 場所の共有物として登録する場合、管理者権限チェック
  - 所有形態の変更機能
依存: T-030, T-020
```

#### T-032: 本棚表示（個人・場所）
```
目的: 自分の本棚、および場所の本棚を一覧表示できる
入力: BookInstances テーブル
成果物: 本棚グリッドコンポーネント、フィルター機能
作業内容:
  - 個人本棚（自分が所有する全 BookInstance）
  - 場所本棚（場所に紐づく全 BookInstance）
  - ステータス別フィルター（貸出可/貸出中/読書中）
  - 場所別グルーピング表示
  - 本の詳細への遷移
依存: T-030, T-031
```

#### T-033: 本の詳細画面
```
目的: 書籍情報、所有者、所在地、感想を一画面で確認できる
入力: Books, BookInstances, Reviews テーブル
成果物: 本の詳細画面コンポーネント
作業内容:
  - 書籍基本情報の表示
  - 所有者一覧（個人 / 場所）とそれぞれのステータス
  - 現在の所在地の表示
  - 感想・レビュー一覧
  - 貸出リクエストボタン（所有者との信頼距離表示付き）
依存: T-030, T-014
```

---

### Phase 4: 貸出管理

#### T-040: 貸出リクエスト送信
```
目的: 本を借りたいユーザーがリクエストを送信できる
入力: セクション5「貸出フロー」
成果物: リクエスト送信UI、確認ダイアログ
作業内容:
  - どの BookInstance を借りるか選択（複数所有者がいる場合）
  - メッセージ入力
  - 信頼距離の表示
  - リクエスト送信
  - 所有者（個人 or 場所管理者）への通知
依存: T-033, T-014
```

#### T-041: 貸出リクエスト承認・管理
```
目的: 所有者がリクエストを承認・拒否できる
入力: Loans テーブル
成果物: リクエスト一覧画面、承認・拒否UI
作業内容:
  - 受信したリクエスト一覧
  - リクエスト詳細（相手の関係性チェーン表示）
  - 承認・拒否ボタン
  - 承認時：BookInstance のステータスと現在地を更新
  - 借用者への通知
依存: T-040
```

#### T-042: 返却フロー
```
目的: 返却の記録と確認ができる
入力: Loans テーブル
成果物: 返却ボタン、返却確認UI
作業内容:
  - 借用者側：「返却した」ボタン
  - 所有者側：「返却を確認」ボタン
  - 確認後：BookInstance のステータスと所在地をホームロケーションに復帰
  - 貸出履歴への記録
依存: T-041
```

#### T-043: 貸出管理ダッシュボード
```
目的: 自分の貸出・借用状況を一覧で把握できる
入力: Loans テーブル
成果物: 貸出管理画面（貸している/借りている のタブ表示）
作業内容:
  - 「貸している」タブ：自分が所有者の active な Loan 一覧
  - 「借りている」タブ：自分が借用者の active な Loan 一覧
  - 各 Loan のステータス表示、アクションボタン
  - 場所の管理者として管理する Loan の表示
  - 履歴表示（返却済み）
依存: T-041, T-042
```

---

### Phase 5: 感想・レビュー

#### T-050: 感想投稿
```
目的: 本に対する感想を星評価とテキストで投稿できる
入力: Reviews テーブル
成果物: 感想投稿フォーム、投稿確認
作業内容:
  - 星評価（1-5）の入力UI
  - テキスト入力
  - 投稿・編集・削除
  - 本の詳細画面への反映
依存: T-033
```

#### T-051: 感想一覧・フィード
```
目的: コミュニティ内の最新の感想を閲覧できる
入力: Reviews テーブル + Relationships テーブル
成果物: 感想フィードコンポーネント
作業内容:
  - 最新の感想一覧（時系列）
  - 関係性に基づくフィルタリング（直接の知り合いの感想を優先表示）
  - 本への遷移、ユーザープロフィールへの遷移
依存: T-050, T-014
```

---

### Phase 6: 検索・探索

#### T-060: 本の検索
```
目的: タイトル・著者・ジャンルで本を検索できる
入力: Books, BookInstances テーブル
成果物: 検索画面コンポーネント
作業内容:
  - テキスト検索（タイトル、著者名）
  - ジャンルタグフィルター
  - 場所フィルター（「○○シェアハウスの本だけ」）
  - ステータスフィルター（貸出可能な本のみ）
  - 信頼距離フィルター（距離1の人の本のみ等）
  - 検索結果の表示（本カード + 所有者・場所情報）
依存: T-032, T-014
```

#### T-061: ユーザー探索
```
目的: コミュニティ内のメンバーを探索できる
入力: Users, Relationships テーブル
成果物: メンバー一覧・検索コンポーネント
作業内容:
  - メンバー一覧（関係性の近い順にソート）
  - 名前検索
  - 関係性チェーンの表示（自分 → ... → 相手）
  - プロフィールへの遷移
依存: T-014
```

---

### Phase 7: 通知

#### T-070: 通知システム
```
目的: 貸出リクエスト、承認、関係性リクエスト等を通知する
入力: 各イベントテーブル
成果物: 通知一覧画面、プッシュ通知設定
作業内容:
  - アプリ内通知（通知一覧画面）
  - 通知の種類：
    - 貸出リクエスト受信
    - リクエスト承認/拒否
    - 返却リクエスト
    - 関係性リクエスト受信
    - 関係性承認
    - 招待リンクの利用
  - 未読バッジ
  - プッシュ通知（モバイル: Expo Push、Web: Web Push）
依存: T-012, T-040, T-041, T-042
```

---

### Phase 8: UI実装

#### T-080: デザインシステム構築
```
目的: 共通コンポーネントとスタイルガイドを構築する
入力: 既存デモ（本のコモンズ_demo.jsx, _web_demo.jsx）のデザイン
成果物: デザインシステムファイル群
作業内容:
  - カラートークン（CSS Variables）
  - タイポグラフィ（Shippori Mincho + Zen Kaku Gothic New）
  - 共通コンポーネント：
    - Button, Input, TextArea
    - Avatar, BookCover
    - StatusPill, TrustBadge（信頼距離表示）
    - Card, Modal, Toast
    - NavigationBar（モバイル）, Sidebar（Web）
  - アニメーション定義
依存: なし（並行作業可能）
```

#### T-081: モバイル版画面実装
```
目的: React Native でモバイル版の全画面を実装する
入力: T-080 のデザインシステム、Phase 1-7 の機能
成果物: モバイルアプリの全画面
作業内容:
  - 5タブ構成（ホーム/検索/本棚/貸出/マイ）
  - 各画面の実装（Phase 1-7 の各タスクの UI 部分）
  - 画面遷移とナビゲーション
  - オフライン対応の検討
依存: T-080, Phase 1-7
```

#### T-082: Web版画面実装
```
目的: Next.js でWeb版の全画面を実装する
入力: T-080 のデザインシステム、Phase 1-7 の機能
成果物: Webアプリの全画面
作業内容:
  - サイドバーナビゲーション
  - 各画面の実装（デスクトップレイアウト）
  - 場所ページ（新規）
  - レスポンシブ対応
依存: T-080, Phase 1-7
```

---

### Phase 9: テスト・デプロイ

#### T-090: E2Eテスト作成
```
目的: 主要フローの自動テストを作成する
成果物: テストファイル群
作業内容:
  - ユーザー登録 → 関係性追加 → 認証完了フロー
  - 本の登録 → 貸出リクエスト → 承認 → 返却フロー
  - 場所の作成 → メンバー追加 → 共有本登録フロー
  - 招待フロー
依存: Phase 1-7
```

#### T-091: デプロイパイプライン構築
```
目的: CI/CD パイプラインを構築する
成果物: GitHub Actions ワークフロー、デプロイ設定
作業内容:
  - Web: Vercel へのデプロイ設定
  - モバイル: EAS Build 設定
  - Supabase マイグレーションの自動実行
  - テストの自動実行
依存: T-090
```

---

## 11. 優先順位とロードマップ

```
Week 1-2:  Phase 0（基盤）+ T-080（デザインシステム）
Week 3-4:  Phase 1（認証・関係性）
Week 5-6:  Phase 2（場所）+ Phase 3（本の管理）
Week 7-8:  Phase 4（貸出）+ Phase 5（感想）
Week 9-10: Phase 6（検索）+ Phase 7（通知）
Week 11-12: Phase 8（UI統合）+ Phase 9（テスト・デプロイ）
```

最初の MVP では以下を必須とする：
1. ユーザー登録と関係性の確認
2. 本の登録（ISBN検索）
3. 場所への紐付け
4. 基本的な貸出フロー
5. モバイル版 UI